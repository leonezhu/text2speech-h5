import { useState, useEffect, useRef } from "react";
import "./App.css";

function App() {
  const [articles, setArticles] = useState([]);
  const [selectedArticle, setSelectedArticle] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [currentTime, setCurrentTime] = useState(0);
  const [displayLanguage, setDisplayLanguage] = useState("both");
  const [showSentences, setShowSentences] = useState([]);
  // const [availableLanguages, setAvailableLanguages] = useState([]);
  const [showConfigModal, setShowConfigModal] = useState(false);
  const [githubRepo, setGithubRepo] = useState("");
  const [isAutoPlay, setIsAutoPlay] = useState(false);
  const [isFirstLoad, setIsFirstLoad] = useState(true);
  const [isAutoPlayTriggered, setIsAutoPlayTriggered] = useState(false);

  const audioRef = useRef(null);
  const GITHUB_BRANCH = "master";

  useEffect(() => {
    // ‰ªé localStorage Ëé∑ÂèñÈÖçÁΩÆ
    const savedRepo = localStorage.getItem("githubRepo");
    if (savedRepo) {
      setGithubRepo(savedRepo);
    } else {
      setShowConfigModal(true);
    }
  }, []);

  useEffect(() => {
    if (githubRepo) {
      fetchArticles();
    }
  }, [githubRepo]);

  const handleConfigSubmit = (repo) => {
    setGithubRepo(repo);
    localStorage.setItem("githubRepo", repo);
    setShowConfigModal(false);
    fetchArticles();
  };

  const fetchArticles = async () => {
    if (!githubRepo) return;
    setLoading(true);
    setError("");
    try {
      const response = await fetch(
        `https://api.github.com/repos/${githubRepo}/contents/articles?ref=${GITHUB_BRANCH}`
      );
      const data = await response.json();

      if (Array.isArray(data)) {
        const articlePromises = data.map(async (file) => {
          const articleResponse = await fetch(file.download_url);
          const articleData = await articleResponse.json();
          return {
            id: file.name.replace(".json", ""),
            ...articleData,
          };
        });

        const articles = await Promise.all(articlePromises);
        const sortedArticles = articles.sort((a, b) =>
          b.id.localeCompare(a.id)
        );
        setArticles(sortedArticles);
        if (sortedArticles.length > 0) {
          handleArticleSelect(sortedArticles[0], true);
        }
      }
    } catch (err) {
      setError("Ëé∑ÂèñÊñáÁ´†ÂàóË°®Â§±Ë¥•: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleArticleSelect = (article, isAutoPlayTriggered = false) => {
    setSelectedArticle(article);
    setIsSidebarOpen(false);

    const languages = Object.keys(article.language_versions || {});
    // setAvailableLanguages(languages);

    const defaultLang = languages.includes("en") ? "en" : languages[0];
    
    if (article?.language_versions?.[defaultLang]) {
      const sentences = article.language_versions[defaultLang].sentences || [];
      const audioUrl = `https://raw.githubusercontent.com/${githubRepo}/${GITHUB_BRANCH}/audio_files/${article.language_versions[defaultLang].audio_filename}`;
      setSelectedArticle((prev) => ({ ...prev, audioUrl }));
      handleDisplayLanguageChange("both", sentences);
      
      // Âè™ÊúâÂú®ËøûÁª≠Êí≠ÊîæËß¶ÂèëÊó∂ÊâçËÆæÁΩÆ‰∏∫falseÊù•ÂêØÂä®Ëá™Âä®Êí≠ÊîæÔºåÂÖ∂‰ªñÊÉÖÂÜµÈÉΩ‰øùÊåÅ‰∏∫true
      setIsFirstLoad(!isAutoPlayTriggered);
    } else {
      setError("ÊñáÁ´†ÂÜÖÂÆπÂä†ËΩΩÂ§±Ë¥•");
    }
  };

  useEffect(() => {
    if (selectedArticle?.audioUrl && audioRef.current) {
      audioRef.current.src = selectedArticle.audioUrl;
      audioRef.current.load();
      // Âè™ÊúâÂú®Ëá™Âä®Êí≠ÊîæÊ®°Âºè‰∏ã‰∏î‰∏çÊòØÈ¶ñÊ¨°Âä†ËΩΩÊó∂ÊâçËá™Âä®Êí≠Êîæ
      if (!isFirstLoad && isAutoPlayTriggered) {
        audioRef.current.play();
      } else if (isFirstLoad) {
        setIsFirstLoad(false);
      }
    }
  }, [selectedArticle, isFirstLoad, isAutoPlayTriggered]);

  // Ê∑ªÂä†Èü≥È¢ëÁªìÊùü‰∫ã‰ª∂Â§ÑÁêÜ
  useEffect(() => {
    const handleAudioEnd = () => {
      if (isAutoPlay && articles.length > 0) {
        const currentIndex = articles.findIndex(article => article.id === selectedArticle.id);
        const nextIndex = (currentIndex + 1) % articles.length;
        setIsAutoPlayTriggered(true);
        handleArticleSelect(articles[nextIndex], false, true);
      }
    };

    if (audioRef.current) {
      audioRef.current.addEventListener('ended', handleAudioEnd);
    }

    return () => {
      if (audioRef.current) {
        audioRef.current.removeEventListener('ended', handleAudioEnd);
      }
    };
  }, [isAutoPlay, articles, selectedArticle]);

  // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
  useEffect(() => {
    const handleKeyPress = (e) => {
      // Â¶ÇÊûúÊ≠£Âú®ËæìÂÖ•ÊñáÊú¨ÔºàÊØîÂ¶ÇÂú®ÈÖçÁΩÆÊ®°ÊÄÅÊ°Ü‰∏≠ÔºâÔºåÂàô‰∏çÂ§ÑÁêÜÁ©∫Ê†ºÈîÆ
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      
      // ÂΩìÊåâ‰∏ãÁ©∫Ê†ºÈîÆ‰∏îÊúâÈÄâ‰∏≠ÁöÑÊñáÁ´†Êó∂
      if (e.code === 'Space' && selectedArticle && audioRef.current) {
        e.preventDefault(); // ÈòªÊ≠¢È°µÈù¢ÊªöÂä®
        if (audioRef.current.paused) {
          audioRef.current.play();
        } else {
          audioRef.current.pause();
        }
      }
    };

    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
    window.addEventListener('keydown', handleKeyPress);

    // Ê∏ÖÁêÜÂáΩÊï∞
    return () => {
      window.removeEventListener('keydown', handleKeyPress);
    };
  }, [selectedArticle]); // ‰æùËµñÈ°πÂåÖÂê´ selectedArticle

  const handleDisplayLanguageChange = (lang, sentences = null) => {
    setDisplayLanguage(lang);
    const targetSentences = sentences || [];
    if (!targetSentences.length) return;

    let temp = [];
    if (lang === "both") {
      temp = targetSentences;
    } else {
      temp = targetSentences.filter(
        (sentence) => sentence.language === lang || sentence.text === "\n"
      );
    }
    setShowSentences(temp);
  };

  return (
    <div className="app-container">
      {isSidebarOpen && (
        <div
          className={`sidebar-overlay ${isSidebarOpen ? 'show' : ''}`}
          onClick={() => setIsSidebarOpen(false)}
        />
      )}
      <div className="top-toolbar">
        <div className="toolbar-right">
          <select
            value={displayLanguage}
            onChange={(e) => handleDisplayLanguageChange(e.target.value)}
            className="language-selector"
          >
            <option value="both">‰∏≠Ëã±ÂØπÁÖß</option>
            <option value="zh">‰ªÖ‰∏≠Êñá</option>
            <option value="en">‰ªÖËã±Êñá</option>
          </select>
       
          <button
            className="toolbar-button"
            onClick={() => setIsAutoPlay(!isAutoPlay)}
            title={isAutoPlay ? "ÂÖ≥Èó≠Âæ™ÁéØÊí≠Êîæ" : "ÂºÄÂêØÂæ™ÁéØÊí≠Êîæ"}
          >
            {isAutoPlay ? "ü§ñ" : "üêª"}
          </button>
          <button
            className="toolbar-button"
            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
            title="ÊñáÁ´†ÂàóË°®"
          >
            ‚ò∞
          </button>
        </div>
      </div>

      {showConfigModal && (
        <div className="modal-overlay">
          <div className="modal-content">
            <h3>ÈÖçÁΩÆ GitHub ‰ªìÂ∫ì</h3>
            <input
              type="text"
              defaultValue={githubRepo}
              placeholder="ËØ∑ËæìÂÖ• GitHub ‰ªìÂ∫ìÂú∞ÂùÄ (Ê†ºÂºè: Áî®Êà∑Âêç/‰ªìÂ∫ìÂêç)"
              onKeyDown={(e) => {
                if (e.key === "Enter") {
                  handleConfigSubmit(e.target.value);
                }
              }}
            />
            <div className="modal-buttons">
              <button
                onClick={() =>
                  handleConfigSubmit(
                    document.querySelector(".modal-content input").value
                  )
                }
              >
                Á°ÆÂÆö
              </button>
              {githubRepo && (
                <button onClick={() => setShowConfigModal(false)}>ÂèñÊ∂à</button>
              )}
            </div>
          </div>
        </div>
      )}

      <div className={`sidebar ${isSidebarOpen ? "open" : ""}`}>
        <div className="toolbar-left">
          <button
            className="toolbar-button"
            onClick={() => setShowConfigModal(true)}
            title="ÈÖçÁΩÆ‰ªìÂ∫ì"
          >
            ‚öôÔ∏è
          </button>
        </div>
        
        {loading ? (
          <div className="loading">Âä†ËΩΩ‰∏≠...</div>
        ) : error ? (
          <div className="error">{error}</div>
        ) : (
          <div className="article-list">
            {articles.map((article) => (
              <div
                key={article.id}
                className={`article-item ${
                  selectedArticle?.id === article.id ? "selected" : ""
                }`}
                onClick={() => handleArticleSelect(article)}
              >
                {article.title || article.id}
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="main-content" onClick={() => isSidebarOpen && setIsSidebarOpen(false)}>
        {selectedArticle ? (
          <div className="article-view">
            <div className="article-content">
              <h2>{selectedArticle.title}</h2>

              {showSentences.map((sentence, index) =>
                sentence.text === "\n" ? (
                  <br key={index} />
                ) : (
                  <span
                    key={index}
                    className={`sentence ${currentTime >= sentence.start_time && currentTime <= sentence.end_time ? "active" : ""}`}
                    onClick={(e) => {
                      console.log(e);
                      if (isSidebarOpen) {
                        setIsSidebarOpen(false);
                        return;
                      }
                      if (audioRef.current) {
                        audioRef.current.currentTime = sentence.start_time;
                        audioRef.current.play();
                      }
                    }}
                    ref={(el) => {
                      if (el && currentTime >= sentence.start_time && currentTime <= sentence.end_time) {
                        el.scrollIntoView({ behavior: "smooth", block: "center" });
                      }
                    }}
                  >
                    {sentence.text}{" "}
                  </span>
                )
              )}
            </div>
          </div>
        ) : loading ? (
          <div className="loading">Âä†ËΩΩ‰∏≠...</div>
        ) : error ? (
          <div className="error">{error}</div>
        ) : null}
      </div>
      {selectedArticle ? (
        <div className="audio-player-bottom">
          <audio
            ref={audioRef}
            controls
            src={selectedArticle.audioUrl}
            onTimeUpdate={(e) => setCurrentTime(e.target.currentTime)}
          >
            ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ
          </audio>
        </div>
      ) : null}
    </div>
  );
}

export default App;
